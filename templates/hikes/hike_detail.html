{% extends "base.html" %}
{% load static %}

{% block title %}{{ hike.title }} - HikeWeather Advisor{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold">{{ hike.title }}</h1>
            <p class="lead">{{ hike.description }}</p>
            <div class="d-flex gap-2 mb-3 flex-wrap">
                <span class="badge difficulty-badge badge-{{ hike.difficulty }}">
                    {{ hike.get_difficulty_display }}
                </span>
                <span class="badge bg-secondary">{{ hike.length_km }} –∫–º</span>
                <span class="badge bg-info">{{ hike.estimated_time_h }} —á</span>
                {% if hike.avg_rating %}
                <span class="badge bg-warning text-dark">
                    <i class="fas fa-star"></i> {{ hike.avg_rating|floatformat:1 }}
                </span>
                {% endif %}
                <span class="badge bg-light text-dark">
                    <i class="fas fa-user"></i> {{ hike.author.username }}
                </span>
            </div>
        </div>
    </div>

    <!-- –ü–æ–≥–æ–¥–∞ –∏ –ø–∞—Ä–∫–æ–≤–∫–∞ -->
    <div class="row mt-4">
        <div class="col-lg-8 mb-4">
            <div class="card hike-card">
                <div class="card-header hike-card-header">
                    <h3 class="mb-0 weather-alert-icon">–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã (API –¥–µ–º–æ)</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> {{ weather.temperature|default:"‚Äî" }}¬∞C</p>
                            <p><strong>ü§î –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫:</strong> {{ weather.feels_like|default:"‚Äî" }}¬∞C</p>
                            <p><strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ weather.description|default:"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å:</strong> {{ weather.humidity|default:"‚Äî" }}%</p>
                            <p><strong>üí® –í–µ—Ç–µ—Ä:</strong> {{ weather.wind_speed|default:"‚Äî" }} –º/—Å</p>
                            <p><strong>üåßÔ∏è –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤:</strong> {{ weather.precipitation_chance|default:"‚Äî" }}%</p>
                            <p><strong>‚≠ê –ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–≥–æ–¥—ã:</strong> {{ weather_score|default:"‚Äî" }}/100 –±–∞–ª–ª–æ–≤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card hike-card shadow-hover">
                <div class="card-header hike-card-header">
                    <h3 class="mb-0 parking-alert-icon">–°—Ç–∞—Ç—É—Å –ø–∞—Ä–∫–æ–≤–∫–∏ (API –¥–µ–º–æ)</h3>
                </div>
                <div class="card-body">
                    <p><strong>üÖøÔ∏è –°—Ç–∞—Ç—É—Å:</strong> {{ parking.status_text|default:"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" }}</p>
                    <p><strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ parking.description|default:"‚Äî" }}</p>
                    <p><strong>üéØ –ë–∞–ª–ª –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:</strong> {{ parking.score|default:"‚Äî" }}/100</p>
                    <p class="mb-0"><small>üïí –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ parking.last_checked|default:"‚Äî" }}</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ -->
    <div class="row mt-4 fade-in">
        <div class="col-12">
            <div class="card hike-card shadow-hover">
                <div class="card-header hike-card-header">
                    <h3 class="mb-0">üìä –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
                </div>
                <div class="card-body">
                    <h4 class="card-title">–û–±—â–∏–π –±–∞–ª–ª: {{ overall_score.overall_score|default:"0" }}/100</h4>
                    
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
                    <div class="hike-progress-container" data-score="{{ overall_score.overall_score|default:0 }}">
                        <div class="hike-progress-bar"></div>
                        <span class="hike-progress-text">{{ overall_score.overall_score|default:"0" }}%</span>
                    </div>
                    
                    <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–ª–æ–≤ -->
                    <div class="row mt-4">
                        <div class="col-md-4 mb-3">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <h5 class="card-title">üå§Ô∏è –ü–æ–≥–æ–¥–∞</h5>
                                    <p class="card-text fs-4">{{ overall_score.breakdown.weather|default:"0/100 (50%)" }}</p>
                                    <small class="text-muted">–í–µ—Å: 50%</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <h5 class="card-title">üÖøÔ∏è –ü–∞—Ä–∫–æ–≤–∫–∞</h5>
                                    <p class="card-text fs-4">{{ overall_score.breakdown.parking|default:"0/100 (30%)" }}</p>
                                    <small class="text-muted">–í–µ—Å: 30%</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card border-info h-100">
                                <div class="card-body text-center">
                                    <h5 class="card-title">ü•æ –°–ª–æ–∂–Ω–æ—Å—Ç—å</h5>
                                    <p class="card-text fs-4">{{ overall_score.breakdown.difficulty|default:"0/100 (20%)" }}</p>
                                    <small class="text-muted">–í–µ—Å: 20%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
    <div class="d-flex justify-content-center mt-4 mb-5 fade-in">
        <form method="post" action="{% url 'toggle_favorite' hike.id %}" class="d-inline favorite-form">
            {% csrf_token %}
            <button type="submit" class="btn favorite-btn btn-{% if is_favorited %}danger{% else %}outline-danger{% endif %} btn-lg px-4 py-3">
                <i class="fas fa-heart me-2"></i>
                {% if is_favorited %}–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ{% else %} –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}
            </button>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ -->
    <div class="card hike-card mt-4 shadow-hover">
        <div class="card-header hike-card-header">
            <h4 class="mb-0"><i class="fas fa-star me-2"></i> –û—Ü–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</h4>
        </div>
        
        <div class="card-body rating-section">
            {% if user.is_authenticated %}
                {% if user_review %}
                    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ—Ç–∑—ã–≤ -->
                    <div class="alert alert-success">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5>‚úÖ –í—ã —É–∂–µ –æ—Ü–µ–Ω–∏–ª–∏ —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç</h5>
                                <div class="rating-display my-3">
                                    {% for i in "12345"|make_list %}
                                        {% if forloop.counter <= user_review.rating %}
                                            <i class="fas fa-star text-warning fa-lg"></i>
                                        {% else %}
                                            <i class="far fa-star text-muted fa-lg"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="ms-2 fw-bold fs-5">{{ user_review.rating }}/5</span>
                                </div>
                                {% if user_review.text %}
                                    <p class="mt-3 mb-2"><strong>üí¨ –í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong></p>
                                    <p class="review-comment">
                                        {{ user_review.text }}
                                    </p>
                                {% endif %}
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i> {{ user_review.created_at|date:"d.m.Y H:i" }}
                                </small>
                            </div>
                            <button class="btn btn-outline-primary" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#editReview">
                                <i class="fas fa-edit me-1"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <div class="collapse mt-4" id="editReview">
                        <h5>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤</h5>
                {% endif %}
                
                <!-- –§–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ -->
                <form method="post" class="{% if user_review %}mt-3{% endif %}">
                    {% csrf_token %}
                    
                    <!-- –û—Ü–µ–Ω–∫–∞ -->
                    <div class="mb-4">
                        <label class="form-label fw-bold fs-5">‚≠ê –í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:</label>
                        <div class="star-rating-buttons">
                            {% for value, text in review_form.rating.field.choices %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="rating" id="rating{{ value }}" 
                                       value="{{ value }}" 
                                       {% if user_review and user_review.rating == value %}checked{% endif %}
                                       required>
                                <label class="form-check-label star-label" for="rating{{ value }}">
                                    <span class="stars">
                                        {% for i in "12345"|make_list %}
                                            {% if forloop.counter <= value %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </span>
                                    <span class="rating-text">{{ text }}</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                    <div class="mb-4">
                        <label for="id_text" class="form-label fw-bold fs-5">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                        <textarea class="form-control" id="id_text" name="text" 
                                  rows="4" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ...">{% if user_review %}{{ user_review.text }}{% endif %}</textarea>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary px-4 py-2">
                            <i class="fas fa-paper-plane me-2"></i> 
                            {% if user_review %}–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∑—ã–≤{% else %}–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É{% endif %}
                        </button>
                        {% if user_review %}
                            <button type="button" class="btn btn-outline-secondary px-4 py-2" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#editReview">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        {% endif %}
                    </div>
                </form>
                
                {% if user_review %}
                    </div> <!-- –∑–∞–∫—Ä—ã–≤–∞–µ–º collapse -->
                {% endif %}
                
            {% else %}
                <!-- –î–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö -->
                <div class="text-center py-5">
                    <div class="display-1 text-muted mb-4">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3>–•–æ—Ç–∏—Ç–µ –æ—Ü–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?</h3>
                    <p class="text-muted mb-4 fs-5">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏ –ø–æ–º–æ—á—å –¥—Ä—É–≥–∏–º —Ç—É—Ä–∏—Å—Ç–∞–º</p>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <a href="{% url 'login' %}" class="btn btn-primary px-4 py-2">
                            <i class="fas fa-sign-in-alt me-2"></i> –í–æ–π—Ç–∏
                        </a>
                        <a href="{% url 'register' %}" class="btn btn-outline-primary px-4 py-2">
                            <i class="fas fa-user-plus me-2"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}